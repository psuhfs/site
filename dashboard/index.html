<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - PSU</title>
  <link rel="stylesheet" href="../assets/css/dashboard.css" />
  <script src="../posthog-config.js"></script>
  <script src="../utils.js"></script>
</head>

<body>
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-info">
          <h1>Dashboard</h1>
          <p class="subtitle">Welcome back! Choose an application to continue</p>
        </div>
      </div>
      <div class="header-actions">
        <button id="themeToggle" class="btn-theme-toggle" aria-label="Toggle theme"
          onclick="Analytics.trackClick('theme_toggle')">
          <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
        <button class="btn-logout" onclick="handleLogout()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Logout
        </button>
      </div>
    </div>
  </header>

  <!-- Main Dashboard -->
  <main class="dashboard-main">
    <div class="dashboard-container">
      <!-- StockOn Card -->
      <div class="dashboard-card">
        <div class="card-icon stockon-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path
              d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
            </path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
          </svg>
        </div>
        <div class="card-content">
          <h2>StockOn</h2>
          <p>Manage inventory and stock orders</p>
          <ul class="card-features">
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Search products
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Filter by location
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Place orders
            </li>
          </ul>
        </div>
        <button class="card-btn stockon-btn"
          onclick="Analytics.trackCardClick('StockOn'); window.location.href='/stockon'">
          Open StockOn
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
          </svg>
        </button>
      </div>

      <!-- WorkOn Card -->
      <div class="dashboard-card">
        <div class="card-icon workon-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <div class="card-content">
          <h2>WorkOn - Points</h2>
          <p>Track employee points and attendance</p>
          <ul class="card-features">
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Assign points
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Track attendance
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Manage shifts
            </li>
          </ul>
        </div>
        <button class="card-btn workon-btn"
          onclick="Analytics.trackCardClick('WorkOn'); window.location.href='/workon'">
          Open WorkOn
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
          </svg>
        </button>
      </div>

      <!-- Signup Card -->
      <div class="dashboard-card signup-card">
        <div class="card-icon signup-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
        </div>
        <div class="card-content">
          <h2>Create Account</h2>
          <p>Add new users to the system</p>
          <ul class="card-features">
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              User registration
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Set permissions
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Assign access
            </li>
          </ul>
        </div>
        <button class="card-btn signup-btn" onclick="openSignupModal()">
          Create Account
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
          </svg>
        </button>
      </div>
    </div>
  </main>

  <!-- Signup Modal -->
  <div id="signupModal" class="modal" style="display: none">
    <div class="modal-overlay" onclick="closeSignupModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Account</h2>
        <button class="modal-close" onclick="closeSignupModal()" aria-label="Close modal">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="signupForm" class="modal-form">
        <div class="form-group">
          <label for="username">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Username
          </label>
          <input type="text" id="username" name="username" placeholder="Choose a username" required
            autocomplete="username" />
        </div>

        <div class="form-group">
          <label for="email">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            Email <span class="optional-badge">Optional</span>
          </label>
          <input type="email" id="email" name="email" placeholder="your.email@example.com" />
        </div>

        <div class="form-group">
          <label for="password">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Password <span class="optional-badge">"temp" by default</span>
          </label>
          <div class="input-with-toggle">
            <input type="password" id="password" name="password" placeholder="Enter password or leave for temp"
              autocomplete="new-password" />
            <button type="button" class="toggle-password" aria-label="Toggle password visibility"
              data-target="password">
              <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <svg class="eye-off-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" style="display: none">
                <path
                  d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                </path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Confirm Password
          </label>
          <div class="input-with-toggle">
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Re-enter your password"
              autocomplete="new-password" required />
            <button type="button" class="toggle-password" aria-label="Toggle password visibility"
              data-target="confirmPassword">
              <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <svg class="eye-off-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" style="display: none">
                <path
                  d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                </path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5"></path>
              <path d="M2 12l10 5 10-5"></path>
            </svg>
            Zone Access
          </label>
          <div id="zoneAccess" class="checkbox-list"></div>
        </div>

        <div class="form-group">
          <label>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path
                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
              </path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            Stock On Access
          </label>
          <div id="stockOnAccess" class="checkbox-list"></div>
        </div>

        <button type="submit" class="btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <polyline points="17 11 19 13 23 9"></polyline>
          </svg>
          Create Account
        </button>
      </form>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal" style="display: none">
    <div class="modal-overlay" onclick="closeSuccessModal()"></div>
    <div class="modal-content success-modal">
      <div class="modal-icon success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <h2>Account Created Successfully!</h2>
      <p class="success-message">The user account has been created and is ready to use.</p>
      <div class="modal-actions">
        <button onclick="createAnotherAccount()" class="btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
          Create Another Account
        </button>
        <button onclick="closeSuccessModal()" class="btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Done
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="dashboard-footer">
    <p>&copy; 2026 Stockon. All rights reserved.</p>
  </footer>

  <script>
    function handleLogout() {
      // Track logout event
      Analytics.trackLogout();

      // Clear token
      document.cookie = "token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"
      // Redirect to login
      window.location.href = "/login"
    }

    // Modal functions
    function openSignupModal() {
      Analytics.trackModal('open', 'signup_modal');
      document.getElementById("signupModal").style.display = "flex"
      document.body.style.overflow = "hidden"
    }

    function closeSignupModal() {
      Analytics.trackModal('close', 'signup_modal');
      document.getElementById("signupModal").style.display = "none"
      document.body.style.overflow = "auto"
    }

    function closeSuccessModal() {
      document.getElementById("successModal").style.display = "none"
    }

    function createAnotherAccount() {
      closeSuccessModal()
      resetSignupForm()
    }

    function resetSignupForm() {
      const form = document.getElementById("signupForm")
      const password = document.getElementById("password")
      const confirmPassword = document.getElementById("confirmPassword")
      const email = document.getElementById("email")

      form.reset()
      password.value = confirmPassword.value = "temp"
      email.value = ""

      const zoneCheckboxes = document.querySelectorAll(".zone-access")
      const stockCheckboxes = document.querySelectorAll(".stock-on-access")
      zoneCheckboxes.forEach(cb => cb.checked = false)
      stockCheckboxes.forEach(cb => cb.checked = false)

      document.getElementById("username").focus()
    }

    function showSuccessModal() {
      closeSignupModal()
      document.getElementById("successModal").style.display = "flex"
    }

    function getSelectedValues(checkboxes) {
      return Array.from(checkboxes)
        .filter((checkbox) => checkbox.checked)
        .map((checkbox) => checkbox.value)
    }

    async function handleAccessLevels(zoneList, stockOnList) {
      let zoneAccess = document.getElementById("zoneAccess")
      let stockOnAccess = document.getElementById("stockOnAccess")

      zoneAccess.innerHTML = ""
      stockOnAccess.innerHTML = ""

      for (let i = 0; i < zoneList.length; i++) {
        let label = document.createElement("label")
        let input = document.createElement("input")
        input.type = "checkbox"
        input.className = "zone-access"
        input.value = zoneList[i]
        label.appendChild(input)
        label.innerHTML = `${label.innerHTML} ${zoneList[i]}`
        zoneAccess.appendChild(label)
      }

      for (let i = 0; i < stockOnList.length; i++) {
        let label = document.createElement("label")
        let input = document.createElement("input")
        input.type = "checkbox"
        input.className = "stock-on-access"
        input.value = stockOnList[i]
        label.appendChild(input)
        label.innerHTML = `${label.innerHTML} ${stockOnList[i]}`
        stockOnAccess.appendChild(label)
      }
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", async () => {
      // Track page view
      Analytics.pageView('Dashboard');

      // Check authentication first
      if (!document.cookie.includes("token")) {
        alert("You must be logged in to access this page.")
        window.location.href = "/login"
        return
      }

      // Verify token with API
      try {
        const authResponse = await apiCallGet(`${BASE_URL}/auth/authenticated`)
        if (!authResponse.ok) {
          alert("Your session has expired. Please login again.")
          window.location.href = "/login"
          return
        }
      } catch (error) {
        console.error("Authentication error:", error)
        alert("Authentication failed. Please login again.")
        window.location.href = "/login"
        return
      }

      setupThemeToggle()

      // Load access levels
      try {
        const zones = await (await apiCallGet(`${BASE_URL}/zones/getZones`)).json()
        const stockAccess = await (await apiCallGet(`${BASE_URL}/zones/getStockAccess`)).json()
        await handleAccessLevels(zones, stockAccess)
      } catch (error) {
        console.error("Error loading access levels:", error)
      }

      // Password visibility toggles
      const toggleButtons = document.querySelectorAll(".toggle-password")
      toggleButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const targetId = button.getAttribute("data-target")
          const passwordInput = document.getElementById(targetId)
          const eyeIcon = button.querySelector(".eye-icon")
          const eyeOffIcon = button.querySelector(".eye-off-icon")

          if (passwordInput.type === "password") {
            passwordInput.type = "text"
            eyeIcon.style.display = "none"
            eyeOffIcon.style.display = "block"
          } else {
            passwordInput.type = "password"
            eyeIcon.style.display = "block"
            eyeOffIcon.style.display = "none"
          }
        })
      })

      // Auto-fill email based on username
      const username = document.getElementById("username")
      const email = document.getElementById("email")
      const password = document.getElementById("password")
      const confirmPassword = document.getElementById("confirmPassword")

      password.value = confirmPassword.value = "temp"
      let emailManuallyEdited = false

      email.addEventListener("input", () => {
        emailManuallyEdited = true
      })

      username.addEventListener("input", (e) => {
        if (!emailManuallyEdited) {
          const usernameValue = e.target.value
          email.value = usernameValue ? `${usernameValue}@psu.edu` : ""
        }
      })

      // Form submission
      const signupForm = document.getElementById("signupForm")
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault()

        if (password.value !== "temp" && password.value !== confirmPassword.value) {
          Analytics.trackError('validation_error', 'Passwords do not match');
          alert("Passwords do not match!")
          return
        }

        try {
          const zoneAccessCheckboxes = document.querySelectorAll(".zone-access")
          const stockOnAccessCheckboxes = document.querySelectorAll(".stock-on-access")
          const zonalAccess = getSelectedValues(zoneAccessCheckboxes)
          const stockonAccess = getSelectedValues(stockOnAccessCheckboxes)

          const response = await apiCallPost(
            `${BASE_URL}/auth/signup`,
            JSON.stringify({
              username: username.value,
              email: email.value,
              password: password.value,
              zonalAccess,
              stockonAccess,
            }),
          )

          if (!response.ok) {
            Analytics.trackFormSubmit('signup_form', false, { error: 'API error' });
            alert("Something went wrong. Please try again.")
          } else {
            Analytics.trackFormSubmit('signup_form', true, {
              username: username.value,
              zones_count: zonalAccess.length,
              stock_access_count: stockonAccess.length
            });
            showSuccessModal()
            resetSignupForm()
          }
        } catch (error) {
          console.error("Signup error:", error)
          Analytics.trackError('signup_error', error.message);
          alert("An error occurred. Please try again.")
        }
      })

      // Close modal on ESC key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (document.getElementById("signupModal").style.display === "flex") {
            closeSignupModal()
          }
          if (document.getElementById("successModal").style.display === "flex") {
            closeSuccessModal()
          }
        }
      })
    })
  </script>
</body>

</html>